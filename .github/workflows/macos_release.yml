name: macOS Release Build

on:
  push:
    branches:
      - main


jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.x'

    - name: Configure Project
      run: |
        ./install.sh -release

    - name: Build Project
      run: |
        ./build.sh -release

    - name: List Build Output
      run: |
        ls -R build/Release

    - name: Prepare Release Assets
      run: |
        mkdir release_assets
        cp build/Release/Vega42 release_assets/Vega42

    - name: Create Tar.gz Archive
      run: |
        tar -czvf Vega42-macos.tar.gz -C release_assets .

    - name: Upload Release Asset - Vega42-macos.tar.gz
      uses: actions/upload-release-asset@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: Vega42-macos.tar.gz
        asset_name: Vega42-macos.tar.gz
        asset_content_type: application/gzip
